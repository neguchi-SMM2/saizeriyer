<!DOCTYPE html>
<html>
    <head>
        <title>Saizeriyer</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/x-icon" href="favicon.ico">
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <h1>サイゼメニュー組み合わせ生成機</h1>
        <p class="info">指定された条件を満たすメニューの組み合わせを生成します。すべて税込価格です。</p>
        <fieldset>
            <legend>条件</legend>
            <div>
                <label for="min_price">値段:</label>
                <input type="number" id="price" name="price" value="1000" min="0" />
            </div>
            <div>
                <input type="checkbox" id="alcohol" name="alcohol" />
                <label for="alcohol">アルコールを含む</label>
            </div>
            <div>
                <input type="checkbox" id="duplicate" name="duplicate" />
                <label for="duplicate">重複を許可</label>
            </div>
            <div>
                <input type="checkbox" id="lunch" name="lunch" />
                <label for="lunch">ランチメニューを含む</label>
            </div>
            <div>
                <input type="checkbox" id="without_id" name="without_id" />
                <label for="without_id">番号なしのメニューを含む</label>
            </div>
            <br>人数
            <div>
                <label for="adult">大人</label>
                <input type="number" id="adult" name="adult" class="noPeople" value="1" />
            </div>
            <div>
                <label for="child">子供</label>
                <input type="number" id="child" name="child" class="noPeople" value="0" />
            </div>
            <br>
            <button id="generate">生成</button>
        </fieldset>

        <div id="result">ここに結果が表示されます。</div>
        <script>
        let menuData = [];

        // JSON読み込み
        fetch("data.json")
        .then(res => res.json())
        .then(data => {
            menuData = data;
        });

        document.getElementById('generate').addEventListener('click', function () {
        const price = parseInt(document.getElementById('price').value, 10);
        const alcohol = document.getElementById('alcohol').checked;
        const duplicate = document.getElementById('duplicate').checked;
        const lunch = document.getElementById('lunch').checked;
        const withoutId = document.getElementById('without_id').checked;
        const adultCount = parseInt(document.getElementById('adult').value, 10);
        const childCount = parseInt(document.getElementById('child').value, 10);
        const peopleCount = adultCount + childCount;

        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = "<p>生成中...</p>";

        setTimeout(() => {
            let filtered = menuData.filter(item => {
            if (!alcohol && item.type === "alcohol") return false;
            if (!lunch && item.type === "lunch") return false;
            if (!withoutId && (item.id === "none" || item.id === "")) return false;
            return true;
            });

            const MAX_ITEMS = 75;
            const MAX_TRY = 200000;

            function getRandomCombo() {
            let combo = [];
            let total = 0;
            let count = Math.floor(Math.random() * MAX_ITEMS) + 1;

            for (let j = 0; j < count; j++) {
                const item = filtered[Math.floor(Math.random() * filtered.length)];

                if (item.type === "lunch") {
                const currentLunches = combo.filter(c => c.type === "lunch");

                if (currentLunches.length >= peopleCount) continue;

                if (!duplicate && currentLunches.some(c => c.name === item.name)) continue;
                }

                if (!duplicate && combo.includes(item)) continue;
                if (total + item.price > price) continue;

                combo.push(item);
                total += item.price;
            }
            return { combo, total };
            }

            let found = null;
            let best = null;

            for (let t = 0; t < MAX_TRY; t++) {
            const { combo, total } = getRandomCombo();
            if (combo.length === 0) continue;

            if (!checkConstraints(combo, adultCount, childCount, peopleCount, duplicate)) continue;

            if (total > price - 100 && total <= price) {
                found = { combo, total };
                break;
            }

            if (!best || Math.abs(price - total) < Math.abs(price - best.total)) {
                best = { combo, total };
            }
            }

            resultDiv.innerHTML = "";
            let target = found || best;

            if (!target) {
            resultDiv.textContent = "組み合わせが見つかりませんでした。";
            return;
            }

            if (!found) {
            const warn = document.createElement("p");
            warn.textContent =
                "条件に合う組み合わせは見つかりませんでしたが、近い金額を表示します。";
            resultDiv.appendChild(warn);
            }

            let summary = {};
            target.combo.forEach(i => {
            if (!summary[i.id + i.name]) {
                summary[i.id + i.name] = { ...i, count: 0 };
            }
            summary[i.id + i.name].count++;
            });

            summary = convertDrinkBars(summary);

            summary = applyPenneLimit(summary);

            const table = document.createElement("div");
            table.className = "menu-table";

            let totalSum = 0;
            
            // summaryをID順にソート（空白のidは最後）
            const sortedItems = Object.values(summary).sort((a, b) => {
                // 空白のidは最後に
                if ((a.id === "" || a.id === "none") && (b.id !== "" && b.id !== "none")) return 1;
                if ((b.id === "" || b.id === "none") && (a.id !== "" && a.id !== "none")) return -1;
                if ((a.id === "" || a.id === "none") && (b.id === "" || b.id === "none")) return 0;
                
                // 数値IDの場合は数値として比較
                const aId = typeof a.id === "number" ? a.id : parseInt(a.id);
                const bId = typeof b.id === "number" ? b.id : parseInt(b.id);
                
                return aId - bId;
            });
            
            sortedItems.forEach(item => {
            const subtotal = item.price * item.count;
            totalSum += subtotal;

            const row = document.createElement("div");
            row.className = "menu-row";

            const idCell = document.createElement("div");
            idCell.className = "menu-cell";
            idCell.textContent = item.id === "none" || item.id === "" ? "" : item.id;

            const nameCell = document.createElement("div");
            nameCell.className = "menu-cell name";
            nameCell.textContent = item.name;

            const countCell = document.createElement("div");
            countCell.className = "menu-cell";
            countCell.textContent = item.count;

            const priceCell = document.createElement("div");
            priceCell.className = "menu-cell";
            priceCell.textContent = subtotal + "円";

            row.appendChild(idCell);
            row.appendChild(nameCell);
            row.appendChild(countCell);
            row.appendChild(priceCell);

            table.appendChild(row);
            });

            resultDiv.appendChild(table);

            const totalP = document.createElement("div");
            totalP.className = "menu-total";
            totalP.textContent = `合計 : ${totalSum}円`;
            resultDiv.appendChild(totalP);
        }, 50);

        function checkConstraints(combo, adultCount, childCount, peopleCount, duplicate) {
            let singleDrinks = combo.filter(i => i.id == 5103).length;
            let setDrinks = combo.filter(i => i.id == 5101).length;
            let kidsDrinks = combo.filter(i => i.id == 5102).length;
            let lunchItems = combo.filter(i => i.type === "lunch");

            if (singleDrinks + setDrinks > adultCount) return false;
            if (kidsDrinks > childCount) return false;
            if (lunchItems.length > peopleCount) return false;

            if (!duplicate) {
            let lunchNames = lunchItems.map(i => i.name);
            let uniqueLunchNames = [...new Set(lunchNames)];
            if (uniqueLunchNames.length < lunchNames.length) return false;
            }

            return true;
        }

        function convertDrinkBars(summary) {
            // フードアイテムの数をカウント（ID範囲: 1100-4399）
            const foodCount = Object.values(summary).reduce((acc, i) => {
                // id が数値の場合のみチェック（空文字列やnoneは除外）
                if (typeof i.id === "number" && i.id >= 1100 && i.id <= 4399) {
                    return acc + i.count;
                }
                return acc;
            }, 0);

            // 単品ドリンクバーとセットドリンクバーのキーを動的に探す
            let singleDrinkKey = null;
            let singleDrinkCount = 0;
            let setDrinkKey = null;
            let setDrinkCount = 0;
            
            for (const [key, item] of Object.entries(summary)) {
                if (item.id === 5103 && item.name === "単品ドリンクバー") {
                    singleDrinkKey = key;
                    singleDrinkCount = item.count;
                } else if (item.id === 5101 && item.name === "セットドリンクバー") {
                    setDrinkKey = key;
                    setDrinkCount = item.count;
                }
            }

            // 1. まず単品→セットへの変換（フードがある場合）
            if (singleDrinkCount > 0 && foodCount > 0) {
                let canConvertToSet = Math.min(foodCount - setDrinkCount, singleDrinkCount);
                
                if (canConvertToSet > 0) {
                    // セットドリンクバーが存在しない場合は新規作成
                    if (!setDrinkKey) {
                        setDrinkKey = "5101セットドリンクバー";
                        summary[setDrinkKey] = {
                            id: 5101,
                            name: "セットドリンクバー",
                            price: 200,
                            count: setDrinkCount,
                        };
                    }
                    
                    // 単品からセットに変換
                    summary[setDrinkKey].count += canConvertToSet;
                    summary[singleDrinkKey].count -= canConvertToSet;
                    setDrinkCount += canConvertToSet;
                    singleDrinkCount -= canConvertToSet;
                    
                    // 単品ドリンクバーが0になったら削除
                    if (summary[singleDrinkKey].count <= 0) {
                        delete summary[singleDrinkKey];
                        singleDrinkKey = null;
                        singleDrinkCount = 0;
                    }
                }
            }

            // 2. セット→単品への変換（セットがフード数を超えている場合）
            if (setDrinkCount > foodCount && setDrinkCount > 0) {
                let excessSet = setDrinkCount - foodCount;
                
                // 単品ドリンクバーが存在しない場合は新規作成
                if (!singleDrinkKey) {
                    singleDrinkKey = "5103単品ドリンクバー";
                    summary[singleDrinkKey] = {
                        id: 5103,
                        name: "単品ドリンクバー",
                        price: 300,
                        count: 0,
                    };
                }
                
                // セットから単品に変換
                summary[singleDrinkKey].count += excessSet;
                summary[setDrinkKey].count -= excessSet;
                
                // セットドリンクバーが0になったら削除
                if (summary[setDrinkKey].count <= 0) {
                    delete summary[setDrinkKey];
                }
            }
            
            return summary;
        }

        function applyPenneLimit(summary) {
            // ペンネ変更の正しいキーを探す（idが空文字列の場合）
            let penneKey = null;
            let penne = null;
            
            // 可能性のあるキーを試す
            const possibleKeys = ["ペンネ変更", "noneペンネ変更", "ペンネ変更"];
            
            for (const key of possibleKeys) {
                if (summary[key]) {
                    penneKey = key;
                    penne = summary[key];
                    break;
                }
            }
            
            // キーが見つからない場合、空文字列のidを持つペンネ変更を探す
            if (!penne) {
                for (const [key, item] of Object.entries(summary)) {
                    if (item.name === "ペンネ変更" && (item.id === "" || item.id === "none")) {
                        penneKey = key;
                        penne = item;
                        break;
                    }
                }
            }
            
            if (!penne) return summary;

            // パスタの数をカウント（ID 2300-2399、但し2325は除く）
            let pastaCount = Object.values(summary).reduce((acc, i) => {
                if (
                    typeof i.id === "number" &&
                    i.id >= 2300 &&
                    i.id < 2400 &&
                    i.id !== 2325
                ) {
                    return acc + i.count;
                }
                return acc;
            }, 0);

            // ペンネ変更の数をパスタの数に制限
            if (penne.count > pastaCount) {
                penne.count = pastaCount;
                // 0になった場合は削除
                if (penne.count <= 0) {
                    delete summary[penneKey];
                }
            }
            
            return summary;
        }
        });
        </script>
    </body>
</html>
