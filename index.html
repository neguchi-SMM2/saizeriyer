<!DOCTYPE html>
<html>
    <head>
        <title>Saizeriyer</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/x-icon" href="favicon.ico">
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <h1>サイゼメニュー組み合わせ生成機</h1>
        <p class="info">指定された条件を満たすメニューの組み合わせを生成します。</p>
        <fieldset>
            <legend>条件</legend>
            <div>
                <label for="min_price">値段:</label>
                <input type="number" id="price" name="price" value="1000" min="0" />
            </div>
            <div>
                <input type="checkbox" id="alcohol" name="alcohol" />
                <label for="alcohol">アルコールを含む</label>
            </div>
            <div>
                <input type="checkbox" id="duplicate" name="duplicate" />
                <label for="duplicate">重複を許可</label>
            </div>
            <div>
                <input type="checkbox" id="lunch" name="lunch" />
                <label for="lunch">ランチメニューを含む</label>
            </div>
            <br>
            <button id="generate">生成</button>
        </fieldset>

        <div id="result">ここに結果が表示されます。</div>
        <script>
        let menuData = [];

        fetch("data.json")
        .then(res => res.json())
        .then(data => {
            menuData = data;
        });

        document.getElementById('generate').addEventListener('click', function () {
        const price = parseInt(document.getElementById('price').value, 10);
        const alcohol = document.getElementById('alcohol').checked;
        const duplicate = document.getElementById('duplicate').checked;
        const lunch = document.getElementById('lunch').checked;

        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = "<p>生成中...</p>";

        setTimeout(() => {
            let filtered = menuData.filter(item => {
            if (!alcohol && item.type === "alcohol") return false;
            if (!lunch && item.type === "lunch") return false;
            return true;
            });

            const MAX_ITEMS = 20;
            const MAX_TRY = 10000;

            function getRandomCombo() {
            let combo = [];
            let total = 0;
            let count = Math.floor(Math.random() * MAX_ITEMS) + 1;

            for (let j = 0; j < count; j++) {
                const item = filtered[Math.floor(Math.random() * filtered.length)];
                if (item.type === "lunch" && combo.some(c => c.type === "lunch")) continue;
                if (!duplicate && combo.includes(item)) continue;
                if (total + item.price > price) continue;

                combo.push(item);
                total += item.price;
            }
            return { combo, total };
            }

            let found = null;
            let best = null;

            for (let t = 0; t < MAX_TRY; t++) {
            const { combo, total } = getRandomCombo();
            if (combo.length === 0) continue;

            if (total > price - 100 && total <= price) {
                found = { combo, total };
                break;
            }

            if (!best || Math.abs(price - total) < Math.abs(price - best.total)) {
                best = { combo, total };
            }
            }

            resultDiv.innerHTML = "";
            let target = found || best;

            if (!target) {
            resultDiv.textContent = "組み合わせが見つかりませんでした。";
            return;
            }

            if (!found) {
            const warn = document.createElement("p");
            warn.textContent = "条件に合う組み合わせは見つかりませんでしたが、近い金額を表示します。";
            resultDiv.appendChild(warn);
            }

            let summary = {};
            target.combo.forEach(i => {
            if (!summary[i.id]) {
                summary[i.id] = { ...i, count: 0 };
            }
            summary[i.id].count++;
            });

            const table = document.createElement("div");
            table.className = "menu-table";

            Object.values(summary).forEach(item => {
            const subtotal = item.price * item.count;

            const row = document.createElement("div");
            row.className = "menu-row";

            const idCell = document.createElement("div");
            idCell.className = "menu-cell";
            idCell.textContent = item.id;

            const nameCell = document.createElement("div");
            nameCell.className = "menu-cell name";
            nameCell.textContent = item.name;

            const countCell = document.createElement("div");
            countCell.className = "menu-cell";
            countCell.textContent = item.count;

            const priceCell = document.createElement("div");
            priceCell.className = "menu-cell";
            priceCell.textContent = subtotal + "円";

            row.appendChild(idCell);
            row.appendChild(nameCell);
            row.appendChild(countCell);
            row.appendChild(priceCell);

            table.appendChild(row);
            });

            resultDiv.appendChild(table);

            const totalP = document.createElement("div");
            totalP.className = "menu-total";
            totalP.textContent = `合計 : ${target.total}円`;
            resultDiv.appendChild(totalP);
        }, 50);
        });
        </script>
    </body>
</html>
